<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Presupuesto Familia Servetti · 2023–2026</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,700;1,300&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
:root {
  --bg:#0d0c09;--bg2:#131209;--bg3:#1a1810;--card:#161510;--border:#252218;
  --gold:#c9a84c;--gold-l:#e0c06a;--gold-d:#6b5825;
  --green:#4caf7d;--green-d:#1a3528;
  --red:#e05c5c;--red-d:#3d1a1a;
  --blue:#5ca8e0;--blue-d:#1a2e3d;
  --purple:#a07cd4;--orange:#e08c5c;
  --text:#ede8d8;--muted:#7a7260;--dim:#3a3828;
  --y23:#c9a84c;--y24:#5ca8e0;--y25:#4caf7d;--y26:#e05c5c;
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");pointer-events:none;z-index:0;opacity:.4}
.wrap{position:relative;z-index:1;max-width:1500px;margin:0 auto;padding:36px 28px 80px}

/* HEADER */
header{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:28px;padding-bottom:24px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:16px}
.hdr-title{font-family:'DM Serif Display',serif;font-size:2.4rem;line-height:1;color:var(--gold-l);letter-spacing:-.02em}
.hdr-title em{font-style:italic;color:var(--muted);font-size:1.8rem}
.hdr-sub{font-family:'DM Mono',monospace;font-size:.62rem;color:var(--muted);letter-spacing:.15em;text-transform:uppercase;margin-top:7px}
.hdr-right{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.usd-box{background:var(--card);border:1px solid var(--gold-d);border-radius:12px;padding:12px 18px}
.usd-box label{font-family:'DM Mono',monospace;font-size:.58rem;color:var(--muted);text-transform:uppercase;letter-spacing:.12em;display:block;margin-bottom:6px}
.usd-row{display:flex;align-items:center;gap:7px}
.usd-sym{font-family:'DM Serif Display',serif;color:var(--gold);font-size:1.1rem}
#usdRate{background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--gold-l);font-family:'DM Mono',monospace;font-size:1rem;padding:4px 8px;width:85px;text-align:center;outline:none;transition:border-color .2s}
#usdRate:focus{border-color:var(--gold-d)}
.usd-tag{font-family:'DM Mono',monospace;font-size:.58rem;color:var(--muted);text-transform:uppercase}

/* SYNC STATUS */
.sync-box{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 18px;display:flex;flex-direction:column;gap:6px}
.sync-title{font-family:'DM Mono',monospace;font-size:.58rem;color:var(--muted);text-transform:uppercase;letter-spacing:.12em}
.sync-row{display:flex;align-items:center;gap:8px}
.sync-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.sync-dot.ok{background:var(--green);box-shadow:0 0 6px var(--green)}
.sync-dot.loading{background:var(--gold);box-shadow:0 0 6px var(--gold);animation:pulse 1s infinite}
.sync-dot.err{background:var(--red);box-shadow:0 0 6px var(--red)}
.sync-lbl{font-family:'DM Mono',monospace;font-size:.62rem;color:var(--text)}
.sync-time{font-family:'DM Mono',monospace;font-size:.56rem;color:var(--muted)}
.sync-btn{font-family:'DM Mono',monospace;font-size:.58rem;padding:4px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--muted);cursor:pointer;transition:all .2s;text-transform:uppercase;letter-spacing:.08em}
.sync-btn:hover{border-color:var(--gold-d);color:var(--gold-l)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* LOADING OVERLAY */
#loadingOverlay{position:fixed;inset:0;background:var(--bg);z-index:100;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px}
.loading-title{font-family:'DM Serif Display',serif;font-size:2rem;color:var(--gold-l)}
.loading-sub{font-family:'DM Mono',monospace;font-size:.7rem;color:var(--muted);letter-spacing:.15em;text-transform:uppercase}
.loading-bar{width:200px;height:2px;background:var(--border);border-radius:2px;overflow:hidden}
.loading-fill{height:100%;background:var(--gold);border-radius:2px;animation:loadbar 1.5s ease infinite}
@keyframes loadbar{0%{width:0;margin-left:0}50%{width:100%}100%{width:0;margin-left:100%}}
.loading-years{display:flex;gap:12px;margin-top:8px}
.ly{font-family:'DM Mono',monospace;font-size:.65rem;padding:4px 12px;border-radius:6px;border:1px solid var(--border);color:var(--muted)}
.ly.done{color:var(--green);border-color:var(--green);background:rgba(76,175,125,.1)}
.ly.active{color:var(--gold);border-color:var(--gold);background:rgba(201,168,76,.1)}

/* TABS */
.tabs{display:flex;gap:8px;margin-bottom:24px;align-items:center;flex-wrap:wrap}
.tab{font-family:'DM Mono',monospace;font-size:.68rem;letter-spacing:.1em;text-transform:uppercase;padding:7px 16px;border-radius:8px;border:1px solid var(--border);background:var(--bg2);color:var(--muted);cursor:pointer;transition:all .2s}
.tab:hover{color:var(--text);border-color:var(--dim)}
.tab.a23{background:rgba(201,168,76,.12);border-color:var(--y23);color:var(--y23)}
.tab.a24{background:rgba(92,168,224,.12);border-color:var(--y24);color:var(--y24)}
.tab.a25{background:rgba(76,175,125,.12);border-color:var(--y25);color:var(--y25)}
.tab.a26{background:rgba(224,92,92,.12);border-color:var(--y26);color:var(--y26)}
.tab.aall{background:rgba(160,124,212,.12);border-color:var(--purple);color:var(--purple)}

/* SECTION */
.sec{font-family:'DM Mono',monospace;font-size:.56rem;letter-spacing:.2em;text-transform:uppercase;color:var(--dim);margin:24px 0 12px;display:flex;align-items:center;gap:10px}
.sec::after{content:'';flex:1;height:1px;background:var(--border)}

/* KPIs */
.kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-bottom:20px}
.kpi{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;position:relative;overflow:hidden;transition:border-color .3s,transform .2s;cursor:default}
.kpi:hover{transform:translateY(-2px);border-color:var(--dim)}
.kpi::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;border-radius:0 0 12px 12px}
.kpi.cgold::after{background:var(--gold)}.kpi.cred::after{background:var(--red)}.kpi.cgreen::after{background:var(--green)}
.kpi.cblue::after{background:var(--blue)}.kpi.cpurple::after{background:var(--purple)}.kpi.corange::after{background:var(--orange)}
.kl{font-family:'DM Mono',monospace;font-size:.53rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin-bottom:7px}
.kv{font-family:'DM Serif Display',serif;font-size:1.45rem;line-height:1}
.kv.gold{color:var(--gold-l)}.kv.red{color:var(--red)}.kv.green{color:var(--green)}.kv.blue{color:var(--blue)}.kv.purple{color:var(--purple)}.kv.orange{color:var(--orange)}
.ks{font-size:.66rem;color:var(--muted);margin-top:4px;font-weight:300}

/* CARDS */
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;transition:border-color .3s}
.card:hover{border-color:var(--dim)}
.ct{font-family:'DM Mono',monospace;font-size:.56rem;letter-spacing:.13em;text-transform:uppercase;color:var(--muted);margin-bottom:16px}
.ct span{color:var(--gold-d);margin-right:6px}

/* GRIDS */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:14px}
.g31{display:grid;grid-template-columns:2fr 1fr;gap:14px;margin-bottom:14px}
.g13{display:grid;grid-template-columns:1fr 2fr;gap:14px;margin-bottom:14px}

/* EXPENSE TABLE */
.etbl{width:100%;border-collapse:collapse;font-size:.76rem}
.etbl th{font-family:'DM Mono',monospace;font-size:.54rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);text-align:left;padding:5px 0;border-bottom:1px solid var(--border)}
.etbl td{padding:7px 0;border-bottom:1px solid var(--bg3);vertical-align:middle}
.etbl tr:last-child td{border-bottom:none}
.cbar{height:3px;border-radius:2px;margin-top:3px}
.pct{font-family:'DM Mono',monospace;font-size:.6rem;padding:2px 6px;border-radius:4px;background:var(--bg3);color:var(--muted)}

/* USD ROWS */
.uro{display:flex;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:.78rem}
.uro:last-child{border-bottom:none}
.umon{font-family:'DM Mono',monospace;font-size:.6rem;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;width:30px}
.ubw{flex:1;margin:0 10px;height:4px;background:var(--border);border-radius:2px;overflow:hidden}
.ubf{height:100%;border-radius:2px;transition:width .5s ease}
.uamt{font-family:'DM Mono',monospace;font-size:.7rem;min-width:80px;text-align:right}
.uamt.pos{color:var(--gold-l)}.uamt.neg{color:var(--red)}

/* ALERTS */
.ai{display:flex;align-items:flex-start;gap:9px;padding:9px 0;border-bottom:1px solid var(--border)}
.ai:last-child{border-bottom:none}
.ad{width:7px;height:7px;border-radius:50%;margin-top:4px;flex-shrink:0}
.ad.red{background:var(--red);box-shadow:0 0 5px var(--red)}.ad.gold{background:var(--gold);box-shadow:0 0 5px var(--gold)}
.ad.green{background:var(--green);box-shadow:0 0 5px var(--green)}.ad.blue{background:var(--blue);box-shadow:0 0 5px var(--blue)}
.at{font-size:.75rem;line-height:1.5;color:var(--text)}.at strong{color:var(--gold-l);font-weight:500}
.am{font-family:'DM Mono',monospace;font-size:.58rem;color:var(--muted);margin-top:2px}

/* SAVINGS */
.sb{border-radius:10px;padding:13px;margin-top:10px;display:flex;flex-direction:column;gap:3px}
.sb.green{background:var(--green-d);border:1px solid var(--green)}.sb.blue{background:var(--blue-d);border:1px solid var(--blue)}.sb.red{background:var(--red-d);border:1px solid var(--red)}
.sl{font-family:'DM Mono',monospace;font-size:.56rem;text-transform:uppercase;letter-spacing:.1em}
.sv{font-family:'DM Serif Display',serif;font-size:1.5rem}
.ss{font-size:.66rem;font-weight:300}
.sb.green .sl,.sb.green .sv,.sb.green .ss{color:var(--green)}
.sb.blue .sl,.sb.blue .sv,.sb.blue .ss{color:var(--blue)}
.sb.red .sl,.sb.red .sv,.sb.red .ss{color:var(--red)}

@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.kpi{animation:fadeUp .4s ease both}
.kpi:nth-child(1){animation-delay:.03s}.kpi:nth-child(2){animation-delay:.06s}.kpi:nth-child(3){animation-delay:.09s}
.kpi:nth-child(4){animation-delay:.12s}.kpi:nth-child(5){animation-delay:.15s}.kpi:nth-child(6){animation-delay:.18s}
.card{animation:fadeUp .4s ease both;animation-delay:.2s}

@media(max-width:1100px){.kpis{grid-template-columns:repeat(3,1fr)}.g2,.g3,.g31,.g13{grid-template-columns:1fr}}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loadingOverlay">
  <div class="loading-title">Familia Servetti</div>
  <div class="loading-sub">Sincronizando con Google Sheets…</div>
  <div class="loading-bar"><div class="loading-fill"></div></div>
  <div class="loading-years">
    <div class="ly" id="ly23">2023</div>
    <div class="ly" id="ly24">2024</div>
    <div class="ly" id="ly25">2025</div>
    <div class="ly" id="ly26">2026</div>
  </div>
</div>

<div class="wrap" id="mainContent" style="display:none">

<!-- HEADER -->
<header>
  <div>
    <div class="hdr-title">Familia Servetti <em>/ 2023–2026</em></div>
    <div class="hdr-sub">Dashboard Financiero · Live desde Google Sheets · Pesos Uruguayos</div>
  </div>
  <div class="hdr-right">
    <div class="sync-box">
      <div class="sync-title">Estado de sincronización</div>
      <div id="syncRows"></div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:4px">
        <button class="sync-btn" onclick="reloadAll()">↻ Actualizar ahora</button>
        <span class="sync-time" id="lastSync"></span>
      </div>
    </div>
    <div class="usd-box">
      <label>Tipo de cambio USD / UYU</label>
      <div class="usd-row">
        <span class="usd-sym">$</span>
        <input type="number" id="usdRate" value="44" min="1" max="9999" step="0.5">
        <span class="usd-tag">UYU = 1 USD</span>
      </div>
    </div>
  </div>
</header>

<!-- TABS -->
<div class="tabs">
  <span style="font-family:'DM Mono',monospace;font-size:.58rem;color:var(--muted);text-transform:uppercase;letter-spacing:.1em">Ver:</span>
  <button class="tab" id="tab23" onclick="setYear(23)">2023</button>
  <button class="tab" id="tab24" onclick="setYear(24)">2024</button>
  <button class="tab" id="tab25" onclick="setYear(25)">2025</button>
  <button class="tab" id="tab26" onclick="setYear(26)">2026 ▸ parcial</button>
  <button class="tab" id="taball" onclick="setAll()">↔ Comparativa</button>
</div>

<!-- ANNUAL VIEW -->
<div id="annualView" style="display:none">
  <div class="sec">Resumen Histórico 2023–2026</div>
  <div class="kpis" id="annKpis"></div>
  <div class="g2">
    <div class="card"><div class="ct"><span>01</span>Ingresos Totales por Año</div><canvas id="cAnnInc" height="100"></canvas></div>
    <div class="card"><div class="ct"><span>02</span>Gastos Operativos por Año</div><canvas id="cAnnExp" height="100"></canvas></div>
  </div>
  <div class="g2">
    <div class="card"><div class="ct"><span>03</span>Tasa de Ahorro / Excedente (%)</div><canvas id="cAnnRate" height="100"></canvas></div>
    <div class="card"><div class="ct"><span>04</span>USD Comprables por Año (excedente)</div><canvas id="cAnnUSD" height="100"></canvas></div>
  </div>
  <div class="card"><div class="ct"><span>05</span>Evolución Mensual de Ingresos — todos los años</div><canvas id="cOverlay" height="60"></canvas></div>
</div>

<!-- YEAR VIEW -->
<div id="yearView">
  <div class="sec" id="yrSec">—</div>
  <div class="kpis" id="yrKpis"></div>
  <div class="g31">
    <div class="card"><div class="ct"><span>01</span>Ingresos vs Gastos vs Diferencia — Mensual</div><canvas id="cMain" height="90"></canvas></div>
    <div class="card"><div class="ct"><span>02</span>Diferencia Neta por Mes</div><canvas id="cNet" height="90"></canvas></div>
  </div>
  <div class="g3">
    <div class="card"><div class="ct"><span>03</span>Categorías de Gasto</div><table class="etbl"><thead><tr><th>Categoría</th><th style="text-align:right">Total</th><th style="text-align:right">% Ing.</th></tr></thead><tbody id="yrTbl"></tbody></table></div>
    <div class="card"><div class="ct"><span>04</span>USD Comprables por Mes</div><div id="yrUSD"></div></div>
    <div class="card"><div class="ct"><span>05</span>Alertas del Año</div><div id="yrAlerts"></div></div>
  </div>
  <div class="g13">
    <div class="card"><div class="ct"><span>06</span>Composición de Ingresos</div><canvas id="cDonut" height="180"></canvas></div>
    <div class="card"><div class="ct"><span>07</span>¿Cuánto podés destinar al ahorro en USD?</div><div id="yrSav"></div></div>
  </div>
</div>

</div><!-- /wrap -->

<script>
// ─── CONFIG ──────────────────────────────────────────────────────────────────
const CSV_URLS = {
  23: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQTRjA3YEVIYmXC2h2vEh2hNULUzbNGo_kPo_8gXssutdfJxnb8ejqdlJu_W4IDsFz8Ncmk59ZYNtqz/pub?gid=1897153401&single=true&output=csv',
  24: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQTRjA3YEVIYmXC2h2vEh2hNULUzbNGo_kPo_8gXssutdfJxnb8ejqdlJu_W4IDsFz8Ncmk59ZYNtqz/pub?gid=1695279686&single=true&output=csv',
  25: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQTRjA3YEVIYmXC2h2vEh2hNULUzbNGo_kPo_8gXssutdfJxnb8ejqdlJu_W4IDsFz8Ncmk59ZYNtqz/pub?gid=2083821237&single=true&output=csv',
  26: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQTRjA3YEVIYmXC2h2vEh2hNULUzbNGo_kPo_8gXssutdfJxnb8ejqdlJu_W4IDsFz8Ncmk59ZYNtqz/pub?gid=2038483427&single=true&output=csv',
};
const YR_COLORS = {23:'#c9a84c',24:'#5ca8e0',25:'#4caf7d',26:'#e05c5c'};
const MESES = ['ENE','FEB','MAR','ABR','MAY','JUN','JUL','AGO','SEP','OCT','NOV','DIC'];
const PALETTE = ['#c9a84c','#5ca8e0','#4caf7d','#e05c5c','#a07cd4','#e08c5c','#5ce0d0','#d48ca0','#9cbc5c','#7cd4c8','#bc9c5c','#e0d45c','#8ca0e0','#bc5ce0'];

let DATA = {};
let usdRate = 44;
let currentYr = 23;
let mode = 'year';
let syncStatus = {23:'loading',24:'loading',25:'loading',26:'loading'};

// ─── HELPERS ─────────────────────────────────────────────────────────────────
const sum = a => (a||[]).reduce((s,v)=>s+(parseFloat(v)||0),0);
const fmt = n => '$'+Math.abs(n).toLocaleString('es-UY',{minimumFractionDigits:0,maximumFractionDigits:0});
const fmtUSD = n => 'USD '+Math.round(Math.abs(n)).toLocaleString('es-UY');
const parseNum = s => {
  if(!s || s==='' || s==='-') return 0;
  // Handle formats like $1.234,56 or 1234.56 or 1,234.56
  let clean = String(s).replace(/[$\s]/g,'');
  // UY format: period as thousand sep, comma as decimal
  if(clean.match(/\./g)?.length===1 && clean.match(/,/g)?.length===1) {
    // could be either format - check position
    const dotPos = clean.lastIndexOf('.');
    const commaPos = clean.lastIndexOf(',');
    if(commaPos > dotPos) { clean = clean.replace(/\./g,'').replace(',','.'); }
    else { clean = clean.replace(/,/g,''); }
  } else if(clean.includes(',') && !clean.includes('.')) {
    clean = clean.replace(',','.');
  } else {
    clean = clean.replace(/\./g,'').replace(',','.');
    if(isNaN(parseFloat(clean))) clean = String(s).replace(/[^0-9.-]/g,'');
  }
  return parseFloat(clean)||0;
};

// ─── CSV PARSER ──────────────────────────────────────────────────────────────
function parseSheetCSV(rows, yr) {
  // Find key rows by scanning first non-empty column (col B = index 1)
  let ingresosStart = -1, gastosStart = -1;
  let ingresoRows = [], gastoRows = [], ahorrosRow = null;
  let totalIngRow = null, mesesCompletos = 12;

  const MONTH_COLS = [2,3,4,5,6,7,8,9,10,11,12,13]; // cols C-N (indices 2-13)

  for(let i=0;i<rows.length;i++){
    const r = rows[i];
    const label = (r[1]||'').toString().trim().toUpperCase();

    if(label==='TIPO DE INGRESOS') { ingresosStart=i; continue; }
    if(label==='GASTOS') { gastosStart=i; continue; }

    if(ingresosStart>=0 && gastosStart<0) {
      if(label==='TOTAL DE INGRESOS') { totalIngRow=r; continue; }
      if(label && label!=='EFECTIVO DISPONIBLE' && label!=='TIPO DE INGRESOS' && !label.startsWith('AÑO')) {
        const vals = MONTH_COLS.map(c=>parseNum(r[c]));
        if(sum(vals)>0) ingresoRows.push({name:r[1],vals});
      }
    }

    if(gastosStart>=0) {
      if(label==='TOTAL DE GASTOS'||label==='DIFERENCIA'||label.startsWith('DIF ')) break;
      if(label==='AHORROS') { ahorrosRow={name:r[1],vals:MONTH_COLS.map(c=>parseNum(r[c]))}; continue; }
      if(label && !label.startsWith('GASTOS') && label!=='TENDENCIA') {
        const vals = MONTH_COLS.map(c=>parseNum(r[c]));
        if(sum(vals)>0 || label) gastoRows.push({name:r[1],vals});
      }
    }
  }

  // Build ingresos array (totals from TOTAL DE INGRESOS row, or sum of income rows)
  let ingresos;
  if(totalIngRow) {
    ingresos = MONTH_COLS.map(c=>parseNum(totalIngRow[c]));
  } else {
    ingresos = MONTH_COLS.map((_,i)=>ingresoRows.reduce((s,r)=>s+r.vals[i],0));
  }

  // Detect how many months have data
  const lastFilledMonth = ingresos.reduce((last,v,i)=>v>0?i:last,-1);
  mesesCompletos = lastFilledMonth>=0 ? lastFilledMonth+1 : 12;

  // Build gastos object
  const gastos = {};
  gastoRows.forEach(r=>{ if(r.name) gastos[r.name.trim()] = r.vals; });

  // Ahorros
  const ahorros = ahorrosRow ? ahorrosRow.vals : new Array(12).fill(0);

  // Income categories for donut
  const ingCateg = {};
  ingresoRows.forEach(r=>{ const t=sum(r.vals); if(t>0) ingCateg[r.name.trim()]=t; });

  // Note for partial years
  let nota = '';
  if(yr===26 && mesesCompletos<=6) nota=`Datos hasta ${MESES[mesesCompletos-1]} 2026`;

  return { label:String(yr==='26'?'2026':yr===26?'2026':'20'+yr), color:YR_COLORS[yr], ingresos, gastos, ahorros, ingCateg, mesesCompletos, nota };
}

// ─── FETCH CSV ────────────────────────────────────────────────────────────────
async function fetchYear(yr) {
  setSyncStatus(yr,'loading');
  updateLoadingUI(yr,'active');
  return new Promise((resolve)=>{
    Papa.parse(CSV_URLS[yr], {
      download:true,
      skipEmptyLines:false,
      complete: (results)=>{
        try {
          DATA[yr] = parseSheetCSV(results.data, yr);
          setSyncStatus(yr,'ok');
          updateLoadingUI(yr,'done');
          resolve(true);
        } catch(e) {
          console.error('Parse error yr'+yr, e);
          setSyncStatus(yr,'err');
          updateLoadingUI(yr,'err');
          resolve(false);
        }
      },
      error: ()=>{ setSyncStatus(yr,'err'); updateLoadingUI(yr,'err'); resolve(false); }
    });
  });
}

function updateLoadingUI(yr, state) {
  const el = document.getElementById('ly'+yr);
  if(!el) return;
  el.className = 'ly ' + (state==='done'?'done':state==='active'?'active':'');
}

async function reloadAll() {
  document.getElementById('lastSync').textContent='';
  await Promise.all([23,24,25,26].map(yr=>fetchYear(yr)));
  const now = new Date();
  document.getElementById('lastSync').textContent = `Última sync: ${now.toLocaleTimeString('es-UY')}`;
  renderSyncRows();
  if(mode==='year') renderYearDetail(currentYr);
  else renderAnnual();
}

function setSyncStatus(yr,status) {
  syncStatus[yr]=status;
  renderSyncRows();
}

function renderSyncRows() {
  const labels = {23:'2023',24:'2024',25:'2025',26:'2026'};
  document.getElementById('syncRows').innerHTML = [23,24,25,26].map(yr=>`
    <div class="sync-row">
      <div class="sync-dot ${syncStatus[yr]}"></div>
      <span class="sync-lbl">${labels[yr]}</span>
      <span class="sync-time" style="margin-left:auto">${syncStatus[yr]==='ok'?'✓ OK':syncStatus[yr]==='loading'?'cargando…':'error'}</span>
    </div>`).join('');
}

// ─── INIT ────────────────────────────────────────────────────────────────────
async function init() {
  renderSyncRows();
  await reloadAll();
  document.getElementById('loadingOverlay').style.display='none';
  document.getElementById('mainContent').style.display='';
  setYear(23);
}

document.getElementById('usdRate').addEventListener('input', function(){
  usdRate = parseFloat(this.value)||44;
  if(mode==='year') renderYearDetail(currentYr);
  else renderAnnual();
});

// ─── YEAR / ALL SWITCH ───────────────────────────────────────────────────────
function setYear(yr) {
  currentYr=yr; mode='year';
  document.getElementById('annualView').style.display='none';
  document.getElementById('yearView').style.display='';
  [23,24,25,26,'all'].forEach(y=>{ const t=document.getElementById('tab'+y); if(t) t.className='tab'; });
  const cls = {23:'a23',24:'a24',25:'a25',26:'a26'};
  const t=document.getElementById('tab'+yr); if(t) t.className='tab '+cls[yr];
  if(DATA[yr]) renderYearDetail(yr);
}

function setAll() {
  mode='all';
  document.getElementById('annualView').style.display='';
  document.getElementById('yearView').style.display='none';
  [23,24,25,26].forEach(y=>{ const t=document.getElementById('tab'+y); if(t) t.className='tab'; });
  document.getElementById('taball').className='tab aall';
  renderAnnual();
}

// ─── CHART FACTORY ───────────────────────────────────────────────────────────
function mkChart(id, cfg) {
  const el=document.getElementById(id); if(!el) return;
  const existing=Chart.getChart(el); if(existing) existing.destroy();
  return new Chart(el.getContext('2d'),cfg);
}
const bOpts = {
  responsive:true,
  plugins:{
    legend:{labels:{color:'#7a7260',font:{family:'DM Mono',size:10},boxWidth:10,padding:10}},
    tooltip:{backgroundColor:'#161510',borderColor:'#252218',borderWidth:1,titleColor:'#c9a84c',bodyColor:'#ede8d8'}
  },
  scales:{
    x:{grid:{color:'#1a1810'},ticks:{color:'#3a3828',font:{family:'DM Mono',size:10}}},
    y:{grid:{color:'#1a1810'},ticks:{color:'#3a3828',font:{family:'DM Mono',size:10},callback:v=>'$'+Math.round(v/1000)+'k'}}
  }
};

// ─── YEAR DETAIL ─────────────────────────────────────────────────────────────
function renderYearDetail(yr) {
  const d=DATA[yr]; if(!d) return;
  const c=d.color;
  const g=MESES.map((_,i)=>Object.values(d.gastos).reduce((s,v)=>s+(v[i]||0),0));
  const gNetArr=g.map((v,i)=>v-(d.ahorros[i]||0));
  const diff=d.ingresos.map((v,i)=>v-g[i]);
  const totalIng=sum(d.ingresos);
  const totalG=sum(g);
  const totalSav=sum(d.ahorros);
  const exc=totalIng-(totalG-totalSav);
  const tasa=totalIng>0?((exc/totalIng)*100).toFixed(1):0;

  document.getElementById('yrSec').textContent=`Detalle ${d.label}${d.nota?' · '+d.nota:''}`;

  // KPIs
  document.getElementById('yrKpis').innerHTML=`
    <div class="kpi cgold"><div class="kl">Ingresos Totales</div><div class="kv gold">${fmt(totalIng)}</div><div class="ks">Prom. ${fmt(totalIng/d.mesesCompletos)}/mes</div></div>
    <div class="kpi cred"><div class="kl">Gastos Operativos</div><div class="kv red">${fmt(totalG-totalSav)}</div><div class="ks">Sin ahorros planificados</div></div>
    <div class="kpi cgreen"><div class="kl">Excedente / Ahorro</div><div class="kv green">${fmt(exc)}</div><div class="ks">${totalSav>0?fmt(totalSav)+' planif.':''}</div></div>
    <div class="kpi cblue"><div class="kl">USD Comprables</div><div class="kv blue">${fmtUSD(exc/usdRate)}</div><div class="ks">@ $${usdRate} UYU</div></div>
    <div class="kpi cpurple"><div class="kl">Tasa de Ahorro</div><div class="kv purple">${tasa}%</div><div class="ks">Meta rec. 20–30%</div></div>
    <div class="kpi corange"><div class="kl">Mejor Mes</div><div class="kv orange">${MESES[diff.indexOf(Math.max(...diff))]}</div><div class="ks">${fmt(Math.max(...diff))} excedente</div></div>`;

  // Chart main
  mkChart('cMain',{type:'bar',data:{labels:MESES,datasets:[
    {label:'Ingresos',data:d.ingresos,backgroundColor:c+'22',borderColor:c+'bb',borderWidth:1.5,borderRadius:4},
    {label:'Gastos',data:gNetArr,backgroundColor:'rgba(224,92,92,0.18)',borderColor:'rgba(224,92,92,0.7)',borderWidth:1.5,borderRadius:4},
    {label:'Diferencia',data:diff,type:'line',borderColor:c,backgroundColor:c+'11',borderWidth:2,tension:.4,pointRadius:3,pointBackgroundColor:c},
  ]},options:{...bOpts,plugins:{...bOpts.plugins,tooltip:{...bOpts.plugins.tooltip,callbacks:{label:ct=>` ${ct.dataset.label}: ${fmt(ct.raw)}`}}}}});

  // Chart net
  mkChart('cNet',{type:'bar',data:{labels:MESES,datasets:[{
    label:'Dif. Neta',data:diff,
    backgroundColor:diff.map(v=>v>=0?'rgba(76,175,125,0.28)':'rgba(224,92,92,0.28)'),
    borderColor:diff.map(v=>v>=0?'rgba(76,175,125,0.9)':'rgba(224,92,92,0.9)'),
    borderWidth:1.5,borderRadius:4,
  }]},options:{...bOpts,plugins:{...bOpts.plugins,legend:{display:false},tooltip:{...bOpts.plugins.tooltip,callbacks:{label:ct=>` ${fmt(ct.raw)}`}}}}});

  // Expense table
  const sg=Object.entries(d.gastos).map(([k,v])=>({name:k,total:sum(v)})).filter(x=>x.total>0).sort((a,b)=>b.total-a.total);
  const maxG2=sg[0]?.total||1;
  document.getElementById('yrTbl').innerHTML=sg.map((c2,i)=>`
    <tr><td><div style="font-size:.74rem">${c2.name}</div><div class="cbar" style="width:${Math.round(c2.total/maxG2*100)}%;background:${PALETTE[i%PALETTE.length]}55;border:1px solid ${PALETTE[i%PALETTE.length]}44"></div></td>
    <td style="text-align:right;font-family:'DM Mono',monospace;font-size:.66rem;color:var(--muted)">${fmt(c2.total)}</td>
    <td style="text-align:right"><span class="pct">${totalIng>0?(c2.total/totalIng*100).toFixed(1):0}%</span></td></tr>`).join('');

  // USD calc
  const maxD=Math.max(...diff.filter(v=>v>0),1);
  document.getElementById('yrUSD').innerHTML=diff.map((v,i)=>`
    <div class="uro">
      <span class="umon">${MESES[i]}</span>
      <div class="ubw"><div class="ubf" style="width:${v>0?Math.round(v/maxD*100):0}%;background:${v>=0?c:'#e05c5c'}"></div></div>
      <span class="uamt ${v>=0?'pos':'neg'}">${v>=0?'':'-'}${fmtUSD(v/usdRate)}</span>
    </div>`).join('');

  // Alerts
  const alerts=genAlerts(yr,d,diff,totalIng,totalG,totalSav);
  document.getElementById('yrAlerts').innerHTML=alerts.map(a=>`
    <div class="ai"><div class="ad ${a.t}"></div>
    <div><div class="at"><strong>${a.title}.</strong> ${a.text}</div><div class="am">${a.meta}</div></div></div>`).join('');

  // Donut
  const dd=Object.entries(d.ingCateg).filter(x=>x[1]>0);
  const dcol=['rgba(201,168,76,.7)','rgba(92,168,224,.6)','rgba(76,175,125,.6)','rgba(160,124,212,.6)','rgba(224,140,92,.6)','rgba(92,224,208,.6)'];
  mkChart('cDonut',{type:'doughnut',data:{labels:dd.map(x=>x[0]),datasets:[{
    data:dd.map(x=>x[1]),backgroundColor:dcol,borderColor:dcol.map(x=>x.replace(/\.\d\)/,'1)')),borderWidth:1.5,hoverOffset:6
  }]},options:{cutout:'62%',plugins:{legend:{position:'bottom',labels:{color:'#7a7260',font:{family:'DM Mono',size:9},boxWidth:8,padding:8}},tooltip:{...bOpts.plugins.tooltip,callbacks:{label:ct=>` ${fmt(ct.raw)} (${totalIng>0?(ct.raw/totalIng*100).toFixed(1):0}%)`}}}}});

  // Savings
  renderSavSection(d,totalIng,totalG,totalSav);
}

// ─── ALERTS GEN ──────────────────────────────────────────────────────────────
function genAlerts(yr,d,diff,totalIng,totalG,totalSav) {
  const a=[];
  const minIdx=diff.indexOf(Math.min(...diff));
  const maxIdx=diff.indexOf(Math.max(...diff));
  if(diff[minIdx]<0) a.push({t:'red',title:`${MESES[minIdx]}: mes crítico`,text:`Los gastos superaron los ingresos.`,meta:`Déficit: ${fmt(diff[minIdx])}`});
  if(Math.max(...diff)>80000) a.push({t:'green',title:`${MESES[maxIdx]}: mejor mes USD`,text:`Mayor excedente del año. Ideal para comprar USD en volumen.`,meta:`${fmt(diff[maxIdx])} = ${fmtUSD(diff[maxIdx]/usdRate)}`});
  const seguros=sum(d.gastos['Seguros']||[]);
  if(seguros>0) a.push({t:'gold',title:'Seguros concentrados',text:'Generan un pico de gasto en el mes de pago. Evaluar prorrateo mensual.',meta:`Total: ${fmt(seguros)}`});
  const patente=sum(d.gastos['Patente']||[]);
  if(patente>0) a.push({t:'gold',title:'Patente anual',text:'Impacto fuerte en liquidez. Conviene provisionar $'+Math.round(patente/12/1000)+'k por mes.',meta:`Total: ${fmt(patente)}`});
  const santander=sum(d.gastos['Tarjeta Santander Sabri']||d.gastos['Santander Sabri']||[]);
  if(santander>0) a.push({t:'gold',title:'Santander Sabri',text:'Gasto importante y variable. Revisar mes a mes.',meta:`Total año: ${fmt(santander)}`});
  const exc=totalIng-(totalG-totalSav);
  if(exc/totalIng>0.4) a.push({t:'green',title:'Tasa de ahorro excelente',text:`Excedente >40% del ingreso. Muy por encima del promedio.`,meta:`${(exc/totalIng*100).toFixed(1)}% = ${fmt(exc)}`});
  if(totalSav>0) a.push({t:'green',title:'Ahorro planificado',text:`Registraste ${fmt(totalSav)} como ahorro formal.`,meta:`${totalIng>0?(totalSav/totalIng*100).toFixed(1):0}% del ingreso`});
  if(yr===26) a.push({t:'blue',title:'Año parcial',text:`Datos hasta ${d.mesesCompletos<12?MESES[d.mesesCompletos-1]:MESES[11]}. El resto del año se actualizará automáticamente cuando cargues datos.`,meta:'Sincronización automática activa'});
  return a.slice(0,6);
}

// ─── SAVINGS SECTION ─────────────────────────────────────────────────────────
function renderSavSection(d,totalIng,totalG,totalSav) {
  const mc=d.mesesCompletos||12;
  const avgIng=sum(d.ingresos.slice(0,mc))/mc;
  const avgG=(totalG-totalSav)/mc;
  const exc=avgIng-avgG;
  document.getElementById('yrSav').innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:12px">
      <div><div style="font-family:'DM Mono',monospace;font-size:.54rem;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin-bottom:4px">Ingreso prom/mes</div><div style="font-family:'DM Serif Display',serif;font-size:1.2rem;color:var(--gold-l)">${fmt(avgIng)}</div></div>
      <div><div style="font-family:'DM Mono',monospace;font-size:.54rem;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin-bottom:4px">Gasto prom/mes</div><div style="font-family:'DM Serif Display',serif;font-size:1.2rem;color:var(--red)">${fmt(avgG)}</div></div>
      <div><div style="font-family:'DM Mono',monospace;font-size:.54rem;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin-bottom:4px">Excedente prom/mes</div><div style="font-family:'DM Serif Display',serif;font-size:1.2rem;color:var(--green)">${fmt(exc)}</div></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px">
      <div class="sb green"><div class="sl">Escenario base</div><div class="sv">${fmt(exc)}</div><div class="ss">${fmtUSD(exc/usdRate)} / mes</div></div>
      <div class="sb green"><div class="sl">+15% ingresos extra</div><div class="sv">${fmt(exc*1.15)}</div><div class="ss">${fmtUSD(exc*1.15/usdRate)} / mes</div></div>
      <div class="sb blue"><div class="sl">Regla 30% del sueldo</div><div class="sv">${fmt(avgIng*.30)}</div><div class="ss">${fmtUSD(avgIng*.30/usdRate)} / mes</div></div>
    </div>
    <div style="margin-top:10px;padding:11px;background:var(--bg3);border-radius:8px;font-size:.75rem;line-height:1.7;color:var(--muted)">
      <strong style="color:var(--gold-l)">Proyección anual:</strong> manteniendo este excedente podés acumular 
      <strong style="color:var(--green)">${fmtUSD(exc*12/usdRate)} USD en 12 meses</strong> 
      al tipo de cambio de $${usdRate} UYU.
    </div>`;
}

// ─── ANNUAL COMPARISON ───────────────────────────────────────────────────────
function renderAnnual() {
  const yrs=[23,24,25,26];
  const labels=['2023','2024','2025','2026*'];
  if(!yrs.every(y=>DATA[y])) return;

  const gastosArr=y=>{const d=DATA[y];return MESES.map((_,i)=>Object.values(d.gastos).reduce((s,v)=>s+(v[i]||0),0));};
  const totalIngs=yrs.map(y=>sum(DATA[y].ingresos));
  const totalGastos=yrs.map(y=>sum(gastosArr(y))-sum(DATA[y].ahorros));
  const excedentes=yrs.map((y,i)=>totalIngs[i]-totalGastos[i]);
  const tasas=yrs.map((y,i)=>totalIngs[i]>0?(excedentes[i]/totalIngs[i]*100).toFixed(1):0);
  const usdA=yrs.map((y,i)=>excedentes[i]/usdRate);

  document.getElementById('annKpis').innerHTML=`
    <div class="kpi cgold"><div class="kl">Mejor año (ingresos)</div><div class="kv gold">2023</div><div class="ks">${fmt(totalIngs[0])}</div></div>
    <div class="kpi cgreen"><div class="kl">Mejor tasa ahorro</div><div class="kv green">2023</div><div class="ks">${tasas[0]}% del ingreso</div></div>
    <div class="kpi cblue"><div class="kl">USD acumulados 2023</div><div class="kv blue">${fmtUSD(usdA[0])}</div><div class="ks">Mayor poder de compra</div></div>
    <div class="kpi corange"><div class="kl">Gastos 2024</div><div class="kv orange">${fmt(totalGastos[1])}</div><div class="ks">Año más austero</div></div>
    <div class="kpi cpurple"><div class="kl">Recuperación 2025</div><div class="kv purple">${fmt(totalIngs[2])}</div><div class="ks">Ingresos estabilizados</div></div>
    <div class="kpi cred"><div class="kl">2026 parcial</div><div class="kv red">${fmt(totalIngs[3])}</div><div class="ks">Solo ${DATA[26].mesesCompletos} meses</div></div>`;

  mkChart('cAnnInc',{type:'bar',data:{labels,datasets:[{label:'Ingresos',data:totalIngs,backgroundColor:yrs.map(y=>DATA[y].color+'33'),borderColor:yrs.map(y=>DATA[y].color),borderWidth:2,borderRadius:6}]},options:{...bOpts,plugins:{...bOpts.plugins,legend:{display:false},tooltip:{...bOpts.plugins.tooltip,callbacks:{label:ct=>` ${fmt(ct.raw)}`}}}}});
  mkChart('cAnnExp',{type:'bar',data:{labels,datasets:[
    {label:'Gastos Operativos',data:totalGastos,backgroundColor:'rgba(224,92,92,.22)',borderColor:'rgba(224,92,92,.8)',borderWidth:2,borderRadius:6},
    {label:'Excedente',data:excedentes,backgroundColor:'rgba(76,175,125,.18)',borderColor:'rgba(76,175,125,.7)',borderWidth:2,borderRadius:6},
  ]},options:{...bOpts,plugins:{...bOpts.plugins,tooltip:{...bOpts.plugins.tooltip,callbacks:{label:ct=>` ${ct.dataset.label}: ${fmt(ct.raw)}`}}}}});
  mkChart('cAnnRate',{type:'bar',data:{labels,datasets:[{label:'Tasa %',data:tasas.map(Number),backgroundColor:yrs.map(y=>DATA[y].color+'44'),borderColor:yrs.map(y=>DATA[y].color),borderWidth:2,borderRadius:6}]},options:{...bOpts,plugins:{...bOpts.plugins,legend:{display:false},tooltip:{...bOpts.plugins.tooltip,callbacks:{label:ct=>` ${ct.raw}%`}}},scales:{...bOpts.scales,y:{...bOpts.scales.y,ticks:{...bOpts.scales.y.ticks,callback:v=>v+'%'}}}}});
  mkChart('cAnnUSD',{type:'bar',data:{labels,datasets:[{label:'USD',data:usdA.map(Math.round),backgroundColor:yrs.map(y=>DATA[y].color+'33'),borderColor:yrs.map(y=>DATA[y].color),borderWidth:2,borderRadius:6}]},options:{...bOpts,plugins:{...bOpts.plugins,legend:{display:false},tooltip:{...bOpts.plugins.tooltip,callbacks:{label:ct=>` ${fmtUSD(ct.raw)}`}}},scales:{...bOpts.scales,y:{...bOpts.scales.y,ticks:{...bOpts.scales.y.ticks,callback:v=>'USD '+Math.round(v/1000)+'k'}}}}});
  mkChart('cOverlay',{type:'line',data:{labels:MESES,datasets:yrs.map(y=>({
    label:DATA[y].label,data:DATA[y].ingresos,borderColor:DATA[y].color,backgroundColor:DATA[y].color+'11',
    borderWidth:2,tension:.4,pointRadius:3,pointBackgroundColor:DATA[y].color,borderDash:y===26?[5,4]:[],
  }))},options:{...bOpts,plugins:{...bOpts.plugins,tooltip:{...bOpts.plugins.tooltip,callbacks:{label:ct=>` ${ct.dataset.label}: ${fmt(ct.raw)}`}}}}});
}

// ─── START ────────────────────────────────────────────────────────────────────
init();
</script>
</body>
</html>
